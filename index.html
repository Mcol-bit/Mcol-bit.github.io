<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>stlite app</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css"
    />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount(
        {
          requirements: [
            "langchain-google-genai",
            "langchain-community",
            "numexpr",
            "langgraph",
            "streamlit",
            "python-dotenv",
            "ddgs",
            "numpy>=1.26.2"
          ],
          entrypoint: "my_mathagent.py",
          files: {
            "my_mathagent.py": `
from langchain_google_genai import ChatGoogleGenerativeAI
import os
from langchain_community.tools import DuckDuckGoSearchResults
from langchain_core.tools import tool
import numexpr as ne
from dotenv import load_dotenv
from langgraph.prebuilt import create_react_agent
import streamlit as st

# Load environment variables from .env file
load_dotenv()

# --- 1. Setup and Tool Definitions ---

# Initialize the search tool
ddg_search = DuckDuckGoSearchResults()

# Create a simple math evaluation tool using numexpr
@tool
def calculate(expression: str) -> str:
    """A highly accurate calculator tool for mathematical expressions. 
    Input should be a numerical expression string (e.g., '10 + 5 * 2')."""
    try:
        # Evaluate the expression safely
        result = ne.evaluate(expression).item()
        return str(result)
    except Exception as e:
        # Return a clear error message if calculation fails
        return f"Error calculating the expression '{expression}': {e}"

# Pass the tools to the agent  
tools = [ddg_search, calculate]

# --- 2. Agent Initialization ---

# The agent will be initialized inside the Streamlit app when the user clicks the button.
# --- 3. Streamlit UI ---

st.title("ðŸ¤– AI Research and Calculation Agent")

st.write("""
This agent can answer questions using DuckDuckGo search and perform calculations.
Your Google API key is required to use the agent. 
""")

# Get Google API Key from user
api_key = st.text_input("Enter your Google API Key:", type="password", key="api_key_input")

# Get user prompt
prompt_text = st.text_area("Ask a question or give a calculation:", height=100, key="prompt_input")

if st.button("Run Agent", key="run_button"):
    if not api_key:
        st.warning("Please enter your Google API Key to run the agent.")
    elif not prompt_text:
        st.warning("Please enter a question or calculation.")
    else:
        st.write("---")
        st.subheader("Agent Output:")
        
        # Use an empty container to stream the response
        response_container = st.empty()
        full_response = ""

        try:
            # Initialize the LLM with the provided key
            llm = ChatGoogleGenerativeAI(model="gemini-pro", temperature=0, google_api_key=api_key)

            # Create the agent using langgraph
            agent_executor = create_react_agent(llm, tools)

            # Stream the response
            for chunk in agent_executor.stream(
                {"messages": [("user", prompt_text)]},
                stream_mode="values"
            ):
                # Get the content of the last message
                last_message = chunk["messages"][-1]
                if hasattr(last_message, 'content'):
                    # Append the content to the full response and display it
                    full_response += str(last_message.content) + " "
                    response_container.markdown(full_response)

        except Exception as e:
            st.error(f"An error occurred: {e}")
`,
          },
        },
        document.getElementById("root")
      );
    </script>
  </body>
</html>
